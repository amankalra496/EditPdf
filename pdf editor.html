<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PDF SKU to Stock Processor</title>
</head>
<body>
  <h2>Upload PDF File</h2>
  <input type="file" id="upload" accept="application/pdf" />
  <button onclick="processPDF()">Process PDF</button>
  
  <div id="results" style="margin-top: 20px;"></div>
  
  <!-- Include PDF-lib -->
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <!-- Include PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 
      'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';
    
    // Stock array with initial quantities of 0
    let stockArray = {
      "dohar olive": 0,
      "dohar pink": 0,
      "60x78 wine": 0,
      "fitted wine": 0,
      "pillow box": 0,
      "pillow grey": 0,
      "pillow foot": 0,
      "pillow pista": 0,
      "1+2 Vegas": 0
    };
    
    // Hardcoded SKU to stock mapping
    const skuToStockMapping = {
      // Example mappings - modify these according to your actual SKUs
      'Olive Dohar': {
        "dohar olive": 1
      },
      'Vegas 1+2': {
        "1+2 Vegas": 1
      },
      'Pink dohar': {
        "dohar pink": 1
      },
      '2pc box,foot,grey,pista': {
        "pillow box": 2,
        "pillow foot": 2,
        "pillow grey": 2,
        "pillow pista": 2
      },
      '60x78 wine': {
        "60x78 wine": 1
      },
      'fitted wine': {
        "fitted wine": 1
      }
      // Add more SKU mappings here as needed
    };
    
    async function processPDF() {
      const fileInput = document.getElementById("upload");
      if (!fileInput.files.length) {
        alert("Please upload a PDF file.");
        return;
      }
      
      const file = fileInput.files[0];
      const arrayBuffer = await file.arrayBuffer();
      const pdfLibDoc = await PDFLib.PDFDocument.load(arrayBuffer);
      const pdfJsDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      const pages = pdfLibDoc.getPages();
      
      // Reset stock array to 0
      for (let key in stockArray) {
        stockArray[key] = 0;
      }
      
      console.log('pages >>> ', pages);
      console.log('Initial stock array:', stockArray);
      
      for (let i = 1; i < pdfJsDoc.numPages; i += 2) {
        const pageTextContent = await pdfJsDoc.getPage(i + 1).then(p => p.getTextContent());
        const text = pageTextContent.items.map(item => item.str).join(" ");
        console.log('text >>> ', text);
        
        // Find all SKU matches on this specific detail page
        const skuMatches = text.match(/\(\s*([^)]+?)\s*\)\s*HSN/gi);
        const orderItemsOnThisPage = [];
        
        if (skuMatches) {
          for (const match of skuMatches) {
            const skuMatch = match.match(/\(\s*([^)]+?)\s*\)\s*HSN/i);
            if (skuMatch) {
              const sku = skuMatch[1].trim();
              
              // Find quantity for this SKU - look for quantity in table structure
              // Pattern: HSN:#### ₹price qty ₹total
              const hsnPattern = new RegExp(`HSN:\\d+\\s+₹[\\d,\\.]+\\s+(\\d+)`, 'i');
              const qtyMatch = text.match(hsnPattern);
              
              let qty = null;
              if (qtyMatch) {
                qty = qtyMatch[1];
              } else {
                // Fallback to original method
                const allNumbers = text.match(/\d+/g);
                const qtyIndex = text.search(/Qty/i);
                if (qtyIndex !== -1 && allNumbers) {
                  const afterQty = text.substring(qtyIndex);
                  const nextNumberMatch = afterQty.match(/\d+/);
                  if (nextNumberMatch) {
                    qty = nextNumberMatch[0];
                  }
                }
              }
              
              console.log(`Found SKU: ${sku}, Quantity: ${qty}`);
              
              if (qty) {
                const orderQty = parseInt(qty);
                orderItemsOnThisPage.push({
                  sku: sku,
                  qty: orderQty
                });
                
                // Process stock requirements based on SKU mapping
                if (skuToStockMapping[sku]) {
                  console.log(`Processing SKU: ${sku} with quantity: ${orderQty}`);
                  
                  for (const [stockItem, baseQty] of Object.entries(skuToStockMapping[sku])) {
                    const totalToAdd = baseQty * orderQty;
                    stockArray[stockItem] += totalToAdd;
                    
                    console.log(`Added ${totalToAdd} to ${stockItem} (base: ${baseQty} * order qty: ${orderQty})`);
                  }
                } else {
                  console.log(`No stock mapping found for SKU: ${sku}`);
                }
              }
            }
          }
        }
        
        console.log(`Page ${i + 1} has ${orderItemsOnThisPage.length} order items:`, orderItemsOnThisPage);
        
        // Continue with original barcode page logic
        if (orderItemsOnThisPage.length > 0) {
          const barcodePageIndex = i - 1;
          const barcodePage = pages[barcodePageIndex];
          console.log('printing on page index:', barcodePageIndex);
          
          if (barcodePage) {
            const { width, height } = barcodePage.getSize();
            const font = await pdfLibDoc.embedFont(PDFLib.StandardFonts.HelveticaBold);
            const textY = 180;
            const textX = 60;
            
            let insertText;
            let fontSize;
            
            if (orderItemsOnThisPage.length > 1) {
              // Multiple order items on this specific page - print 'Multi' ONLY
              insertText = 'Multi';
              fontSize = 12;
              
              console.log(`Placing text "${insertText}" at x: ${textX}, y: ${textY}, page height: ${height}, fontSize: ${fontSize}`);
              
              barcodePage.drawText(insertText, {
                x: textX,
                y: textY,
                size: fontSize,
                font: font,
                color: PDFLib.rgb(0, 0, 0)
              });
            } else {
              // Single order item on this page - check quantity
              const item = orderItemsOnThisPage[0];
              
              if (item.qty > 1) {
                // Draw quantity in larger font, then " * SKU" in normal font
                const qtyText = item.qty.toString();
                const restText = ` * ${item.sku}`;
                
                // Draw quantity in larger font
                barcodePage.drawText(qtyText, {
                  x: textX,
                  y: textY,
                  size: 18,
                  font: font,
                  color: PDFLib.rgb(0, 0, 0)
                });
                
                // Calculate width of quantity text to position the rest
                const qtyWidth = font.widthOfTextAtSize(qtyText, 18);
                
                // Draw " * SKU" in normal font
                barcodePage.drawText(restText, {
                  x: textX + qtyWidth,
                  y: textY,
                  size: 12,
                  font: font,
                  color: PDFLib.rgb(0, 0, 0)
                });
                
                console.log(`Placing quantity "${qtyText}" (size 18) and "${restText}" (size 12) at x: ${textX}, y: ${textY}`);
              } else {
                // Quantity is 1, draw normally
                insertText = `${item.qty} * ${item.sku}`;
                barcodePage.drawText(insertText, {
                  x: textX,
                  y: textY,
                  size: 12,
                  font: font,
                  color: PDFLib.rgb(0, 0, 0)
                });
                
                console.log(`Placing text "${insertText}" at x: ${textX}, y: ${textY}, fontSize: 12`);
              }
            }
          }
        }
      }
      
      // Display final stock array
      displayStockArray();
      
      const modifiedPdfBytes = await pdfLibDoc.save();
      const blob = new Blob([modifiedPdfBytes], { type: "application/pdf" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "updated.pdf";
      link.click();
    }
    
    function displayStockArray() {
      const resultsDiv = document.getElementById('results');
      
      // Define the custom sort order
      const sortOrder = [
        "1+1", "1+2", "72x78", "60x78", "36x78", "72x72",
        "Dohar Single", "Dohar Double", "Set Double", 
        "Com Double", "Com Single"
      ];
      
      // Filter out items with zero quantity
      const filteredStock = Object.entries(stockArray).filter(([item, qty]) => qty > 0);
      
      // Sort according to the custom order
      filteredStock.sort(([itemA], [itemB]) => {
        const indexA = sortOrder.findIndex(order => itemA.toLowerCase().includes(order.toLowerCase()));
        const indexB = sortOrder.findIndex(order => itemB.toLowerCase().includes(order.toLowerCase()));
        
        // If both items match the sort order, use their order index
        if (indexA !== -1 && indexB !== -1) {
          return indexA - indexB;
        }
        
        // If only one matches, put the matching one first
        if (indexA !== -1) return -1;
        if (indexB !== -1) return 1;
        
        // If neither matches, sort alphabetically
        return itemA.localeCompare(itemB);
      });
      
      let html = '<h3>Final Stock:</h3>';
      
      if (filteredStock.length === 0) {
        html += '<p>No items with quantity greater than 0</p>';
      } else {
        html += '<ul>';
        for (const [stockItem, quantity] of filteredStock) {
          html += `<li><strong>${stockItem}:</strong> ${quantity}</li>`;
        }
        html += '</ul>';
      }
      
      resultsDiv.innerHTML = html;
      
      console.log('Filtered and Sorted Stock Array:', filteredStock);
      console.log('Full Stock Array:', stockArray);
    }
  </script>
</body>
</html>